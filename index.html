<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚«ãƒªãƒ¢</title>
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
</head>
<body>

<div id="welcome" class="screen active">
  <h1>å€Ÿã‚Šãƒ¢ã€‚</h1>

  <button
    onclick="showBorrow()"
    style="background:#1976D2; color:white; font-weight:bold;"
  >
    å€Ÿã‚Šã‚‹
  </button>

  <button
    onclick="showStatus()"
    style="background:#4CAF50; color:white;"
  >
    è¿”æ¸ˆçŠ¶æ³ã‚’è¦‹ã‚‹
  </button>

  <p style="
    margin-top: 40px;
    text-align: center;
    font-size: 12px;
    color: #999;
  ">
    Â© ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒŠãƒ³ã‚·ãƒ£ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—
  </p>
</div>


<div id="borrow" class="screen">
  <h1>å€Ÿã‚Šã‚‹</h1>
  <div class="card-box">

  <label>åç›®ï¼ˆä»»æ„ï¼‰</label>
  <input type="text" id="purpose" placeholder="ä¾‹ï¼šã‚¹ãƒãƒ›ä»£">

  <label>é‡‘é¡</label>
  <input type="number" id="amount" placeholder="é‡‘é¡ã‚’å…¥åŠ›" oninput="calc()">

  <label>åˆ†å‰²å›æ•°</label>
  <select id="installments" onchange="calc()">
    <option value="1">ç¿Œæœˆä¸€æ‹¬æ‰•ã„ï¼ˆæ‰‹æ•°æ–™1%ï¼‰</option>
    <option value="3">3å›æ‰•ã„ï¼ˆæ‰‹æ•°æ–™6%ï¼‰</option>
    <option value="6">6å›æ‰•ã„ï¼ˆæ‰‹æ•°æ–™8%ï¼‰</option>
    <option value="10">10å›æ‰•ã„ï¼ˆæ‰‹æ•°æ–™10%ï¼‰</option>
    <option value="18">18å›æ‰•ã„ï¼ˆæ‰‹æ•°æ–™11%ï¼‰</option>
  </select>

</div>
  <div id="result" class="result card-box" style="display:none; overflow:hidden;">
    <div id="resultText"></div>
    <div id="planText" class="plan-info"></div>
    <hr style="border:0; border-top:1px solid #ccc; margin:10px 0;">
    <label style="font-size:14px; color:#2196F3;">å€Ÿå…¥æ—¥</label>
    <input type="date" id="borrowDate" onchange="calc()" style="width: 100%; box-sizing: border-box;">
    <button onclick="borrowConfirm()" style="background:#2196F3; color:white;">ã“ã®æ¡ä»¶ã§å€Ÿã‚Šã‚‹</button>
</div>
  <button onclick="goBackWithReset()" style="background:#888; color:white;">æˆ»ã‚‹</button>
</div>

<div id="status" class="screen">
  <h1>è¿”æ¸ˆçŠ¶æ³</h1>
  <div id="statusSummary" class="summary-section"></div>
  <div id="statusList"></div>
  <button onclick="goBack()" style="background:#888; color:white; margin-top:20px;">æˆ»ã‚‹</button>
</div>

<script>
// åˆæœŸçŠ¶æ…‹ã‚’å±¥æ­´ã«ç™»éŒ²
history.replaceState({ screen: "welcome" }, "", "#welcome");

  let viewDate = new Date();

  function switchScreen(id, push = true) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const target = document.getElementById(id);
  if (target) target.classList.add('active');

  if (push) {
    history.pushState({ screen: id }, "", "#" + id);
  }
}

function showBorrow() { 
  const dateInput = document.getElementById("borrowDate");
  // ã™ã§ã«å…¥åŠ›ãŒã‚ã‚‹ï¼ˆæ‰‹å…¥åŠ›ä¸­ï¼‰ãªã‚‰ä¸Šæ›¸ãã—ãªã„
  if (!dateInput.value) {
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
  }
  switchScreen('borrow'); 
}

  function showStatus() { 
    viewDate = new Date(); 
    renderStatus(); 
    switchScreen('status'); 
  }

  function goBackWithReset() { 
    resetBorrowForm(); 
    switchScreen('welcome'); 
  }

  function goBack() { 
    switchScreen('welcome'); 
  }

  function resetBorrowForm() {
    document.getElementById("purpose").value = ""; 
    document.getElementById("amount").value = "";
    document.getElementById("borrowDate").value = ""; // è¿½åŠ ï¼šæ—¥ä»˜ã‚‚ãƒªã‚»ãƒƒãƒˆ
    document.getElementById("result").style.display = "none";
}

  const rates = { 1: 0.01, 3: 0.06, 6: 0.08, 10: 0.10, 18: 0.11 };

function calc() {
  const a = Number(document.getElementById("amount").value);
  const n = Number(document.getElementById("installments").value);
  const bDateStr = document.getElementById("borrowDate").value;

  // 1. é‡‘é¡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ãªã„æ™‚ã¯çµæœã‚’éš ã—ã¦çµ‚äº†
  if (a <= 0) {
    document.getElementById("result").style.display = "none";
    return;
  }

  // 2. é‡‘é¡ãŒã‚ã‚Œã°ã€ã¾ãšã¯ã€Œè¨ˆç®—çµæœï¼ˆãŠé‡‘ï¼‰ã€ã ã‘è¡¨ç¤ºã™ã‚‹
  const fee = a * rates[n];
  const total = Math.ceil(a + fee);
  const monthly = Math.ceil(total / n);
  const payLabel = (n === 1) ? "ç¿Œæœˆã®è¿”æ¸ˆé¡" : "æœˆã€…ã®è¿”æ¸ˆé¡";

  document.getElementById("result").style.display = "block";
  document.getElementById("resultText").innerHTML = `
    æ‰‹æ•°æ–™ï¼š${fee.toLocaleString()}å††<br>
    ç·è¿”æ¸ˆé¡ï¼š${total.toLocaleString()}å††<br>
    <strong>${payLabel}ï¼š${monthly.toLocaleString()}å††</strong>
  `;

  // 3. æ—¥ä»˜ã®ãƒã‚§ãƒƒã‚¯ï¼ˆ11/31ãªã©ã®ç„¡åŠ¹ãªæ—¥ä»˜ã‚‚ã“ã“ã§åˆ¤å®šï¼‰
  const bDate = new Date(bDateStr + "T00:00:00");
  const isValidDate = bDateStr && !isNaN(bDate.getTime());

  if (isValidDate) {
    // æ—¥ä»˜ãŒæ­£ã—ã„å ´åˆã®ã¿ã€è¿”æ¸ˆè¨ˆç”»ã‚’è¡¨ç¤º
    const start = new Date(bDate.getFullYear(), bDate.getMonth() + 1, 25);
    const end = new Date(bDate.getFullYear(), bDate.getMonth() + n, 25);
    
    let planMsg = "";
    if (n === 1) {
      planMsg = `ğŸ—“ è¿”æ¸ˆæ—¥ï¼š${start.getFullYear()}å¹´${start.getMonth() + 1}æœˆ25æ—¥ (ä¸€æ‹¬æ‰•ã„)`;
    } else {
      planMsg = `ğŸ—“ è¿”æ¸ˆè¨ˆç”»ï¼š${start.getFullYear()}å¹´${start.getMonth() + 1}æœˆ ã€œ ${end.getFullYear()}å¹´${end.getMonth() + 1}æœˆ (${n}å›æ‰•ã„)`;
    }
    document.getElementById("planText").innerHTML = planMsg;
  } else {
    // æ—¥ä»˜ãŒå…¥åŠ›é€”ä¸­ã€ã¾ãŸã¯ç„¡åŠ¹ãªå ´åˆã¯ã€æ¡ˆå†…ã‚’è¡¨ç¤ºã—ã¦ã‚«ãƒ¼ãƒ‰è‡ªä½“ã¯æ®‹ã™
    document.getElementById("planText").innerHTML = "<span style='color:orange; font-size:12px;'>âš ï¸ æ­£ã—ã„æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>";
  }
}

  function borrowConfirm() {
    const a = Number(document.getElementById("amount").value);
    const n = Number(document.getElementById("installments").value);
    const bDate = document.getElementById("borrowDate").value;
    if (a <= 0 || !bDate) return;
    const fee = a * rates[n];
    const total = Math.ceil(a + fee);
    const data = { 
      purpose: document.getElementById("purpose").value || "æœªå…¥åŠ›",
      date: new Date(bDate + "T00:00:00").toISOString(),
      principal: a, 
      total: total, 
      installments: n, 
      monthly: Math.ceil(total/n), 
      remaining: n, 
      id: Date.now()
    };
    const b = JSON.parse(localStorage.getItem("borrows") || "[]");
    b.push(data);
    localStorage.setItem("borrows", JSON.stringify(b));
    alert("ç™»éŒ²ã—ã¾ã—ãŸ");
    resetBorrowForm(); goBack();
  }

  function changeMonth(diff) {
    viewDate.setMonth(viewDate.getMonth() + diff);
    renderStatus();
  }

  function renderStatus() {
    const summaryArea = document.getElementById("statusSummary");
    const listArea = document.getElementById("statusList");
    let borrows = JSON.parse(localStorage.getItem("borrows") || "[]");
    
    const now = new Date();
    const todayZero = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const targetYear = viewDate.getFullYear();
    const targetMonth = viewDate.getMonth();
    const target25Time = new Date(targetYear, targetMonth, 25).getTime();

    let monthlySum = 0;
    borrows.forEach(b => {
      const d = new Date(b.date);
      b.allPayDates = [];
      for(let i = 1; i <= b.installments; i++) {
        b.allPayDates.push(new Date(d.getFullYear(), d.getMonth() + i, 25).getTime());
      }
      const nextIdx = b.installments - b.remaining;
      b.nextPayDateObj = new Date(b.allPayDates[nextIdx] || b.allPayDates[b.allPayDates.length-1]);
      
      const hasPaymentInTargetMonth = b.allPayDates.some((time, idx) => {
          return time === target25Time && idx >= (b.installments - b.remaining);
      });
      if (hasPaymentInTargetMonth) {
        monthlySum += b.monthly;
        b.isTarget = true;
      } else {
        b.isTarget = false;
      }
    });

    borrows.sort((a, b) => a.nextPayDateObj - b.nextPayDateObj);
    const totalRemaining = borrows.reduce((s, b) => s + (b.monthly * b.remaining), 0);
    const totalInitial = borrows.reduce((s, b) => s + b.total, 0);
    const progressPercent = totalInitial > 0 ? Math.round(((totalInitial - totalRemaining) / totalInitial) * 100) : 100;

    // --- ã“ã“ã‹ã‚‰ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¤å®š ---
    const today = new Date();
    const isAfter25th = (today.getDate() >= 25); 
    const isViewingCurrentMonth = (targetYear === today.getFullYear() && targetMonth === today.getMonth());

   // --- ã“ã“ã‹ã‚‰æ›¸ãæ›ãˆï¼ˆsummaryArea.innerHTML ã®å¾ŒåŠéƒ¨åˆ†ï¼‰ ---
    summaryArea.innerHTML = `
      <div class="summary-box monthly">
        <div class="month-selector">
          <button class="month-btn" onclick="changeMonth(-1)">ï¼œ</button>
          <div class="current-month-label">${targetYear}å¹´ ${targetMonth + 1}æœˆ</div>
          <button class="month-btn" onclick="changeMonth(1)">ï¼</button>
        </div>
        <small style="color:#aaa;">ä»Šæœˆã®è¿”æ¸ˆé¡</small>
        <span class="monthly-amount">
          Â¥${monthlySum.toLocaleString()}
          ${monthlySum === 0 ? "<span style='font-size:14px;color:#4CAF50;'> æ¸ˆ</span>" : ""}
        </span>

        ${(isAfter25th && isViewingCurrentMonth && monthlySum > 0) ? `
          <button onclick="payAllThisMonth()" style="margin-top:10px;background:#4CAF50;color:white;">
            ä»Šæœˆåˆ†ã‚’ã¾ã¨ã‚ã¦è¿”æ¸ˆ
          </button>
        ` : ""}
      </div>
      
      <div class="summary-box total">
        <div style="display: flex; justify-content: space-between; align-items: baseline;">
          <small style="color:#666;">å€Ÿå…¥åˆè¨ˆ</small>
          <span style="font-size: 12px; color: #666;">æ®‹ã‚Šï¼š${100 - progressPercent}%</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
          <strong style="font-size: 20px;">Â¥${totalInitial.toLocaleString()}</strong>
          <span style="font-weight: bold; color: #4CAF50;">${progressPercent}%</span>
        </div>
        <div class="progress-container">
          <div class="progress-bar" style="width:${progressPercent}%"></div>
        </div>
      </div>
    `;

    listArea.innerHTML = "";
    ["æœªè¿”æ¸ˆ", "å®Œæ¸ˆæ¸ˆã¿"].forEach(type => {
      const isOn = type === "æœªè¿”æ¸ˆ";
      const filtered = borrows.filter(b => isOn ? b.remaining > 0 : b.remaining <= 0);
      if (filtered.length > 0 || isOn) {
        const h2 = document.createElement("h2");
        h2.innerText = isOn ? "â³ æœªè¿”æ¸ˆ" : "âœ… å®Œæ¸ˆæ¸ˆã¿";
        listArea.appendChild(h2);
        
        filtered.forEach(b => {
          const div = document.createElement("div");
          div.className = "card";
          div.style.borderLeft = "5px solid " + (isOn ? "#2196F3" : "#9e9e9e");
          if (isOn && !b.isTarget) div.style.opacity = "0.4";
          const nd = b.nextPayDateObj;
          const dayClass = (isOn && nd.getTime() <= todayZero) ? "class='alert-overdue'" : "";
          const listLabel = (b.installments === 1) ? "è¿”æ¸ˆé¡" : "æœˆã€…";
          
          div.innerHTML = `
            <strong>ğŸ“Œ ${b.purpose}</strong><br>
            <span class="label-width">å…ƒé‡‘ï¼š</span>Â¥${(b.principal || 0).toLocaleString()}<br>
            <span class="label-width">ç·é¡ï¼š</span>Â¥${b.total.toLocaleString()}<br>
            ${isOn ? `<span class="label-width">${listLabel}ï¼š</span>Â¥${b.monthly.toLocaleString()}<br>
                       <span class="label-width">æ¬¡ã®è¿”æ¸ˆæ—¥ï¼š</span><span ${dayClass}>${nd.getFullYear()}å¹´${nd.getMonth()+1}æœˆ25æ—¥</span><br>` : ""}
            <span class="label-width">å›æ•°ï¼š</span>${b.remaining} / ${b.installments} å›
            <div class="btn-group">
              ${isOn ? `<button onclick="payOneById(${b.id})" class="btn-main">1å›è¿”æ¸ˆ</button>` : ""}
              <button onclick="toggleMenuById(${b.id})" class="btn-sub">ãã®ä»–</button>
            </div>
            <div id="extra-${b.id}" class="extra-menu">
              <button onclick="undoPayById(${b.id})" class="btn-undo">æˆ»ã™</button>
              <button onclick="deleteItemById(${b.id})" class="btn-del">å‰Šé™¤</button>
            </div>
          `;
          listArea.appendChild(div);
        });
      }
    });
  }

  function payOneById(id) {
    let b = JSON.parse(localStorage.getItem("borrows"));
    const idx = b.findIndex(item => item.id === id);
    if (confirm(b[idx].purpose + " ã‚’1å›åˆ†è¿”æ¸ˆã—ã¾ã™ã‹ï¼Ÿ")) {
      b[idx].remaining--; 
      localStorage.setItem("borrows", JSON.stringify(b)); 
      renderStatus();
    }
  }

  function toggleMenuById(id) {
    const menu = document.getElementById('extra-' + id);
    document.querySelectorAll('.extra-menu').forEach(m => { 
      if(m.id !== 'extra-'+id) m.style.display = 'none'; 
    });
    if(menu) menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
  }

  function undoPayById(id) {
    let b = JSON.parse(localStorage.getItem("borrows"));
    const idx = b.findIndex(item => item.id === id);
    if (b[idx].remaining < b[idx].installments) {
      b[idx].remaining++; 
      localStorage.setItem("borrows", JSON.stringify(b)); 
      renderStatus();
    }
  }

  function deleteItemById(id) {
    let b = JSON.parse(localStorage.getItem("borrows"));
    const idx = b.findIndex(item => item.id === id);
    if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      b.splice(idx, 1); 
      localStorage.setItem("borrows", JSON.stringify(b)); 
      renderStatus();
    }
  }
function payAllThisMonth() {
  let borrows = JSON.parse(localStorage.getItem("borrows") || "[]");

  // â‘  ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  if (!confirm("ä»Šæœˆã®è¿”æ¸ˆäºˆå®šã‚’ã™ã¹ã¦ã€Œè¿”æ¸ˆæ¸ˆã¿ã€ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;

  // â‘¡ ã€Œä»Šæœˆï¼ˆè¡¨ç¤ºä¸­ï¼‰ã®25æ—¥ã€ã‚’æ•°å€¤ã§å–å¾—
  const targetYear = viewDate.getFullYear();
  const targetMonth = viewDate.getMonth();
  const target25Time = new Date(targetYear, targetMonth, 25).getTime();

  let changed = false;

  borrows.forEach(b => {
    if (b.remaining <= 0) return;

    const startDate = new Date(b.date);
    // ãã®å€Ÿå…¥ã®ã€Œæ¬¡ã®è¿”æ¸ˆäºˆå®šæ—¥ã€ã‚’ç®—å‡º
    const nextIdx = b.installments - b.remaining;
    const thisPayDate = new Date(
      startDate.getFullYear(),
      startDate.getMonth() + nextIdx + 1,
      25
    ).getTime();

    // â‘¢ ã€Œè¡¨ç¤ºä¸­ã®25æ—¥ã€ã¨ã€Œäºˆå®šæ—¥ã€ãŒä¸€è‡´ã—ãŸã‚‰è¿”æ¸ˆå®Ÿè¡Œ
    if (thisPayDate === target25Time) {
      b.remaining--;
      changed = true;
    }
  });

  if (changed) {
    localStorage.setItem("borrows", JSON.stringify(borrows));
    renderStatus(); // ç”»é¢ã‚’æ›´æ–°
    alert("è¿”æ¸ˆã‚’å®Œäº†ã—ã¾ã—ãŸï¼");
  } else {
    alert("ä»Šæœˆåˆ†ã®è¿”æ¸ˆå¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
  }
}
window.addEventListener("popstate", (e) => {
  if (e.state && e.state.screen) {
    switchScreen(e.state.screen, false);
  }
});

function applyTheme() {
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  document.body.classList.toggle('theme-dark', prefersDark);
}

applyTheme();

</script>

<script>
  // OSã®è¨­å®šã«åˆã‚ã›ã¦åˆæœŸãƒ†ãƒ¼ãƒã‚’æ±ºå®š
  if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
    document.body.classList.add("theme-dark");
  }

  // æ‰‹å‹•åˆ‡ã‚Šæ›¿ãˆç”¨ï¼ˆå¾Œã§ãƒœã‚¿ãƒ³ã«ã¤ãªãï¼‰
  function toggleTheme() {
    document.body.classList.toggle("theme-dark");
  }
</script>

<script>
  // OSã®ãƒ†ãƒ¼ãƒã‚’å–å¾—
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

  // localStorage ã«ä¿å­˜ãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆ
  const savedTheme = localStorage.getItem("theme");

  if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
    document.body.classList.add("theme-dark");
  } else {
    document.body.classList.remove("theme-dark");
  }
</script>

</body>
</html>